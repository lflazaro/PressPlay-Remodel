<UserControl x:Class="PressPlay.Timeline.TimelineControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:svgc="http://sharpvectors.codeplex.com/svgc/"
             xmlns:local="clr-namespace:PressPlay.Timeline"
             xmlns:converters="clr-namespace:PressPlay.Converters"
             xmlns:customControls="clr-namespace:PressPlay.CustomControls"
             mc:Ignorable="d"
             Background="#2a2e32"
             MinHeight="150"
             PreviewMouseMove="TimelineControl_PreviewMouseMove"
             PreviewMouseLeftButtonUp="TimelineControl_PreviewMouseLeftButtonUp"
             PreviewMouseRightButtonDown="TracksCanvas_PreviewMouseRightButtonDown"
             PreviewDragOver="Timeline_PreviewDragOver"
             PreviewDrop="Timeline_PreviewDrop"
             PreviewKeyUp="Timeline_PreviewKeyUp"
             AllowDrop="True"
             Focusable="True"
             d:DesignHeight="450" d:DesignWidth="800">

    <!-- Converters -->
    <UserControl.Resources>
        <converters:TimelineSelectedToolToSelectedConverter x:Key="ToolSelectionConverter"/>
        <converters:TrackItemDataToPositionConverter      x:Key="TrackToPosConverter"/>
        <converters:NeedlePositionConverter               x:Key="NeedlePosConverter"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Tool Buttons -->
        <Border Grid.Row="0" BorderBrush="Gray" BorderThickness="1">
            <StackPanel Orientation="Horizontal">
                <Grid Width="100"/>
                <!-- Selection Tool -->
                <!-- Cutting Tool -->
            </StackPanel>
        </Border>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="15"/>
            </Grid.RowDefinitions>

            <!-- Track Headers -->
            <Grid Grid.Column="0"
            Width="{Binding Project.TrackHeadersWidth,
                            RelativeSource={RelativeSource Mode=FindAncestor,
                                                            AncestorType={x:Type local:TimelineControl}}}">
                <StackPanel>
                    <Grid Height="30">
                        <TextBlock Text="Tracks"
                       Foreground="WhiteSmoke"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"/>
                    </Grid>
                    <ItemsControl ItemsSource="{Binding Project.Tracks,
                                            RelativeSource={RelativeSource Mode=FindAncestor,
                                                                    AncestorType={x:Type local:TimelineControl}}}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Height="{Binding Height}"
                        Background="#FF2C2C2C"
                        BorderBrush="Gray"
                        BorderThickness="0.5">
                                    <TextBlock Text="{Binding Name}"
                             Margin="3,0"
                             VerticalAlignment="Center"
                             Foreground="WhiteSmoke"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Grid>

            <!-- Timeline Canvas -->
            <ScrollViewer x:Name="tracksHScrollView"
                    Grid.Column="1"
                    HorizontalScrollBarVisibility="Hidden"
              VerticalScrollBarVisibility="Auto"
                    PreviewMouseWheel="TracksScrollView_PreviewMouseWheel">
                <Canvas x:Name="RootCanvas" Width="1700"
          HorizontalAlignment="Left"
          PreviewMouseLeftButtonDown="TracksCanvas_PreviewMouseLeftButtonDown">

                    <local:TimelineHeaderControl x:Name="header"
                      Project="{Binding Project,
                          RelativeSource={RelativeSource Mode=FindAncestor,
                                                  AncestorType={x:Type local:TimelineControl}}}"
                      Width="{Binding ActualWidth, ElementName=RootCanvas}" />

                    <ItemsControl x:Name="tracksControl"
                        ItemsSource="{Binding Project.Tracks,
                                              RelativeSource={RelativeSource Mode=FindAncestor,
                                                                      AncestorType={x:Type local:TimelineControl}}}"
                        Width="{Binding ActualWidth, ElementName=tracksHScrollView}"

                        Margin="0,30,0,0">
                        <ItemsControl.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Paste"
                          Click="PasteItem_Click"
                          InputGestureText="Ctrl+V"/>
                            </ContextMenu>
                        </ItemsControl.ContextMenu>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Height="{Binding Height}"
                        Width="{Binding Width,
                                        RelativeSource={RelativeSource Mode=FindAncestor,
                                                                AncestorType={x:Type ItemsControl}}}"
                        Background="#FF2C2C2C"
                        BorderBrush="Gray"
                        BorderThickness="0.5"
                MinHeight="80">
                                    <ItemsControl ItemsSource="{Binding Items}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <local:TrackItemControl/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Left">
                                                    <Setter.Value>
                                                        <MultiBinding Converter="{StaticResource TrackToPosConverter}">
                                                            <Binding Path="Project"
                                       RelativeSource="{RelativeSource Mode=FindAncestor,
                                                               AncestorType={x:Type local:TimelineControl}}"/>
                                                            <Binding Path="Project.TimelineZoom"
                                       RelativeSource="{RelativeSource Mode=FindAncestor,
                                                               AncestorType={x:Type local:TimelineControl}}"/>
                                                            <Binding Path="."/>
                                                            <Binding Path="Position"/>
                                                            <Binding Path="Start"/>
                                                            <Binding Path="End"/>
                                                        </MultiBinding>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                    </ItemsControl>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <local:TimelineNeedleControl x:Name="needle">
                        <local:TimelineNeedleControl.Style>
                            <Style TargetType="local:TimelineNeedleControl">
                                <Setter Property="Canvas.Left">
                                    <Setter.Value>
                                        <MultiBinding Converter="{StaticResource NeedlePosConverter}">
                                            <Binding Path="Project"
                               RelativeSource="{RelativeSource Mode=FindAncestor,
                                                               AncestorType={x:Type local:TimelineControl}}"/>
                                            <Binding Path="Project.TimelineZoom"
                               RelativeSource="{RelativeSource Mode=FindAncestor,
                                                               AncestorType={x:Type local:TimelineControl}}"/>
                                            <Binding Path="Project.NeedlePositionTime"
                               RelativeSource="{RelativeSource Mode=FindAncestor,
                                                               AncestorType={x:Type local:TimelineControl}}"/>
                                        </MultiBinding>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </local:TimelineNeedleControl.Style>
                    </local:TimelineNeedleControl>

                </Canvas>
            </ScrollViewer>

            <!-- BindableScrollBar from PressPlay.Timeline -->
            <local:BindableScrollBar Grid.Column="1"
                               Grid.Row="1"
                               Orientation="Horizontal"
                               VerticalAlignment="Bottom"
                               BoundScrollViewer="{Binding ElementName=tracksHScrollView}"/>
        </Grid>
    </Grid>
</UserControl>